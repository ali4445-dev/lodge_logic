# Add Guest House Screen - Implementation Guide

## Overview
The `AddGuestHouseScreen` now properly uses the updated schema and CRUD operations via `GuestHouseService`.

## Database Fields Being Stored

When a guest house is added, the following fields are stored in the `guesthouses` table:

```
- guesthouse_id: Auto-generated (Primary Key)
- owner_id: Current authenticated user ID
- name: Guest house name
- address: Street address
- city: City name
- country: Country name
- total_rooms: Number of rooms
- description: Guest house description
- amenities: List of amenities (JSON array)
- images: List of image URLs (JSON array)
- is_active: Boolean (default: true)
- created_at: Auto-generated timestamp
```

## Form Fields in UI

1. **Guest House Information Section**
   - Name (required)
   - Description (optional)

2. **Location Details Section**
   - Country (required)
   - City (required)
   - Street/Address (required)

3. **Room Details Section**
   - Number of Rooms (required, digits only)
   - Price Per Night (optional, digits only)

4. **Amenities Section**
   - Standard toggles: Balcony, Kitchen, WiFi, Parking, AC
   - Custom amenities input field

5. **Image Upload Section**
   - Multi-image picker
   - Images are uploaded to Supabase storage

## Submission Flow

### Step 1: Validation
```dart
- Check all required fields are filled
- Validate: name, city, country, address, rooms
- Price Per Night is optional (used for room pricing later)
```

### Step 2: Image Upload
```dart
- If images are selected:
  - Loop through each image
  - Upload to Supabase storage bucket: "guesthouse-images"
  - File path: guesthouse_images/{filename}
  - Get public URL for each image
  - Store URLs in imageUrls list
```

### Step 3: Amenities Collection
```dart
- Combine standard toggles with custom amenities
- Returns: List<String> of all selected amenities
- Example: ['WiFi', 'Parking', 'Hot Water', 'TV']
```

### Step 4: Create GuestHouse Object
```dart
GuestHouse(
  ownerId: user.id,
  name: nameController.text.trim(),
  address: streetController.text.trim(),
  city: cityController.text.trim(),
  country: countryController.text.trim(),
  totalRooms: int.parse(roomController.text),
  description: descriptionController.text.trim(),
  amenities: _getAllAmenitiesSelected(),
  images: imageUrls,
  isActive: true,
)
```

### Step 5: Call GuestHouseService
```dart
final success = await GuestHouseService.addGuestHouse(guestHouse);
```

### Step 6: Handle Response
```dart
if (success) {
  Show success message
  Navigate back to previous screen after 1 second
} else {
  Show error message
}
```

## Service Layer Integration

### GuestHouseService.addGuestHouse()
**Purpose**: Handle CRUD operation for creating guest houses

**What it does**:
1. Sets the `ownerId` to current authenticated user
2. Calls Supabase insert on `guesthouses` table
3. Returns boolean indicating success

**Usage**:
```dart
final success = await GuestHouseService.addGuestHouse(guestHouse);
```

### ImageService.uploadImage()
**Purpose**: Upload image to Supabase storage

**Parameters**:
- `imageBytes`: Uint8List of image data
- `fileName`: Name for the file (includes timestamp)

**Returns**: Public URL string or null on failure

**Storage Path**: `guesthouse_images/{filename}`

**Bucket**: `guesthouse-images`

**Usage**:
```dart
final imageUrl = await ImageService.uploadImage(imageBytes, fileName);
```

## Error Handling

1. **No authenticated user**: Throws "User not authenticated"
2. **Image upload fails**: Logs error but continues (non-blocking)
3. **Empty required fields**: Shows snackbar with error message
4. **Service error**: Shows snackbar with error details
5. **No selected images**: Guest house created with empty images list

## Form Validation

| Field | Required | Type | Validation |
|-------|----------|------|-----------|
| Name | Yes | String | Non-empty |
| City | Yes | String | Non-empty |
| Country | Yes | String | Non-empty |
| Address | Yes | String | Non-empty |
| Total Rooms | Yes | Integer | Digits only |
| Description | No | String | - |
| Amenities | No | List | - |
| Price Per Night | No | Integer | Digits only |
| Images | No | List | - |

## Key Features

✅ **Schema Alignment**: Uses updated GuestHouse model fields
✅ **Service Integration**: Uses GuestHouseService.addGuestHouse()
✅ **Image Upload**: Automatic image upload to Supabase storage
✅ **Amenity Management**: Combines standard + custom amenities
✅ **Error Handling**: Comprehensive error messages and logging
✅ **User Feedback**: Loading states, snackbars, success/error indicators
✅ **Automatic User ID**: Sets ownerId from authenticated user
✅ **Timestamp**: createdAt auto-generated by Supabase

## Testing the Implementation

1. **Add Guest House**:
   - Fill all required fields
   - Select images
   - Select amenities
   - Click submit

2. **Verify Data**:
   - Check Supabase `guesthouses` table
   - Verify all fields are populated correctly
   - Check images are in storage bucket
   - Verify amenities are properly formatted

3. **Check Errors**:
   - Try submitting with empty fields
   - Check console for error messages
   - Verify snackbars show appropriate messages

## Notes

- Price Per Night is for future use (room-level pricing)
- Images are uploaded with timestamp to ensure uniqueness
- Amenities are stored as JSON array in database
- ownerId is automatically set from current auth user
- is_active defaults to true
- All text inputs are trimmed before storing

## Database Table Structure

```sql
CREATE TABLE guesthouses (
  guesthouse_id SERIAL PRIMARY KEY,
  owner_id UUID NOT NULL REFERENCES users(user_id),
  name VARCHAR(255) NOT NULL,
  address VARCHAR(255),
  city VARCHAR(100) NOT NULL,
  country VARCHAR(100) NOT NULL,
  total_rooms INTEGER NOT NULL,
  description TEXT,
  amenities JSON,
  images JSON,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
)
```

## Future Enhancements

1. Room creation during guest house registration
2. Auto-generate rooms with default pricing
3. Batch image upload with progress tracking
4. Image preview before upload
5. Drag-and-drop image upload
6. Image optimization before upload
